= REMOcRA - Document d’installation (DIT)
:Author:    Atol C&D
:Email:     remocra-projet@atolcd.com
:Date:      01/09/2025
:Revision:  1.0.0
:imagesdir: images/
:experimental:
:icons: font
:toc:
:numbered:

<<<
== Introduction générale

Ce document d’installation (DIT) est à destination des administrateurs système en charge de l’installation de l’outil REMOcRA. De ce fait, un niveau minimum de connaissances sur les technologies est requis, faute de quoi les informations contenues dans ce document ne pourront pas suffire.

== Présentation générale de l'outil REMOcRA

L’outil REMOcRA est détaillé dans le document d’architecture technique (DAT). Veuillez vous reporter à ce document pour obtenir plus d’informations sur le fonctionnement général de l'outil REMOcRA.

== Serveur d’application
=== Prérequis

Pour l’installation de l’application, il a été choisi d’utiliser docker et compose pour tous les services. Il faut donc au préalable vous assurer que docker est bien présent et installer le plugins docker compose si nécessaire :
[source,console]
----
sudo apt-get update
sudo apt-get install docker-compose-plugin
----

=== Dépôt du fichier compose.yaml

Créer un dossier `/opt/remocra`. Lui attribuer les droits “remocra”, à l’aide de la commande suivante :

[source,console]
----
chown -R remocra: /opt/remocra
----

Dans ce dossier, ajouter un fichier nommé `compose.yaml`. Renseigner le contenu suivant :
[source,yaml]
----
services:
  remocra:
    image: client-docker-registry.atolcd.com/atolcd/remocra-v3:${REMOCRA_VERSION}
    user: "${REMOCRA_UID:-2000}:${REMOCRA_GID:-2000}"
    volumes:
      - /var/log/remocra:/var/log/remocra
      - /var/lib/remocra:/var/lib/remocra
    environment:
      #JAVA_OPTS: "-XX:MaxRAMPercentage=75 -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=127.0.0.1:5005"
      GLOWROOT_ENABLED: "true"
      GLOWROOT_PORT: "4000"
      LANG: "fr_FR.UTF-8"
      REMOCRA_PORT: ${REMOCRA_PORT}
      # Accès à la base de données remocra
      POSTGRES_DB_HOSTNAME: ${POSTGRES_DB_HOSTNAME}
      POSTGRES_DB_USERNAME: ${POSTGRES_DB_USERNAME}
      POSTGRES_DB_PASSWORD: ${POSTGRES_DB_PASSWORD}
      CODE_SDIS: ${CODE_SDIS}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      SMTP_USER: ${SMTP_USER}
      SMTP_FROM: ${SMTP_FROM}
      SMTP_URL: ${SMTP_URL}
      SMTP_PORT: ${SMTP_PORT}
      URL_SITE: ${URL_SITE}
      CLIENT_SECRET: ${CLIENT_SECRET}
      BASE_URI: ${BASE_URI}
      EPSG_NAME: ${EPSG_NAME}
      EPSG_PROJECTION: ${EPSG_PROJECTION}
      REMOCRA_VERSION: ${REMOCRA_VERSION}
      GEOSERVER_URL: ${GEOSERVER_URL}
      NEXSIS_TEST_TOKEN: ${NEXSIS_TEST_TOKEN}
    healthcheck:
      test: curl --fail -s http://localhost:8881/ || exit 1
      interval: 1m30s
      timeout: 10s
      retries: 3
    network_mode: host
    restart: always

  keycloak:
    image: client-docker-registry.atolcd.com/atolcd/remocra-v3-keycloak:${REMOCRA_VERSION}
    environment:
      - KC_HOSTNAME=${BASE_URI}
      - KEYCLOAK_ADMIN
      - KEYCLOAK_ADMIN_PASSWORD
      - KC_DB_SCHEMA=keycloak
      - KC_HTTP_ENABLED=true
      - KC_PROXY_HEADERS=xforwarded
      - KC_DB_URL=jdbc:postgresql://localhost/keycloak
      - KC_DB_USERNAME=${DB_USER_KEYCLOAK}
      - KC_DB_PASSWORD=${DB_PASSWORD_KEYCLOAK}
      # configuration du realm "remocra"
      - CLIENT_SECRET
      - REMOCRA_URL
    healthcheck:
      test: curl --fail -s http://localhost:8080/ || exit 1
      interval: 1m30s
      timeout: 10s
      retries: 3
    network_mode: host
    volumes:
      - /var/lib/remocra/images/ressources:/opt/keycloak/themes/remocra/login/resources/img:ro
    restart: always

  geoserver:
    image: client-docker-registry.atolcd.com/atolcd/remocra-v3-geoserver:${REMOCRA_VERSION}
    user: "${REMOCRA_UID:-2000}:${REMOCRA_GID:-2000}"
    healthcheck:
      test: curl --fail -s http://localhost:8090/geoserver || exit 1
      interval: 1m30s
      timeout: 10s
      retries: 3
    volumes:
      - /var/opt/geoserver:/var/opt/geoserver
      - /var/lib/remocra/images/symbologie:/var/opt/geoserver/workspaces/remocra/styles/symbologie:ro
    environment:
      GLOWROOT_ENABLED: "true"
      GLOWROOT_PORT: "4001"
      GEOSERVER_URL: ${GEOSERVER_URL}
      GEOSERVER_USER: ${GEOSERVER_USER}
      GEOSERVER_PASSWORD: ${GEOSERVER_PASSWORD}
      POSTGIS_HOSTNAME: ${POSTGRES_DB_HOSTNAME}
      POSTGIS_USER: ${POSTGRES_DB_USERNAME}
      POSTGIS_PASSWORD: ${POSTGRES_DB_PASSWORD}
    network_mode: host
    restart: always
----

=== Mise en place des variables d’environnement
Pour que le fichier compose.yaml ait tous les paramètres, il faut créer dans le même répertoire `/opt/remocra/` un fichier `.env` qui contiendra les éléments suivants :

[source,properties]
----
REMOCRA_VERSION=1.0-a9

# Postgres
POSTGRES_DB_HOSTNAME=localhost
POSTGRES_DB_NAME=remocra
POSTGRES_DB_USERNAME=remocra
POSTGRES_DB_PASSWORD=xxxxxxxxxxxxxxxxxx

REMOCRA_PORT=8881

KEYCLOAK_ADMIN=kcadmin
KEYCLOAK_ADMIN_PASSWORD=xxxxxxxxxxxxxx
DB_PASSWORD_KEYCLOAK=xxxxxxxxxxxxxxx
DB_USER_KEYCLOAK=keycloak
CLIENT_SECRET=remocra

# URL de l’application remocra
REMOCRA_URL=https://xxxxxxxxxxxxxxxxxxx

CLIENT_ID=remocra

# URL public de Keycloak
BASE_URI=https://xxxxxxxxxxxxxx-auth.com

REALM=remocra
CLIENT_SECRET=remocra

# Code de votre SDIS (par exemple SDIS_01)
CODE_SDIS=XXX
SMTP_USER=""
SMTP_PASSWORD=""
SMTP_FROM=""
SMTP_URL=""
SMTP_PORT=25
URL_SITE=""

EPSG_NAME="EPSG:2154"
EPSG_PROJECTION="+proj=lcc +lat_1=49 +lat_2=44 +lat_0=46.5 +lon_0=3 +x_0=700000 +y_0=6600000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"

# APACHE HOP
APACHE_HOP_ENABLE=true
APACHE_HOP_URL=http://localhost:8060/hop
APACHE_HOP_USERNAME=admin
APACHE_HOP_PASSWORD=xxxxxxxxxxxxxxxxx

# NexSIS
NEXSIS_TEST_TOKEN=xxxxxxxxxxxxxxxxx
----

=== Explication des variables d’environnement

|===
| | Description | Variable | Valeur par défaut

.4+| *Base de données*
| POSTGRES_DB_HOSTNAME | Nom d’hôte de la base de données PostgreSQL |
| POSTGRES_DB_NAME | Nom de la base de données PostgreSQL (par défaut _remocra_) |
| POSTGRES_DB_USERNAME | Nom de l’utilisateur PostgreSQL (par défaut _remocra_)  |
| POSTGRES_DB_PASSWORD | Mot de passe de l’utilisateur PostgreSQL  |
.7+| *Informations pour l’application REMOcRA*
| REMOCRA_VERSION | Version de REMOcRA à installer  |
| REMOCRA_PORT | Port utilisé pour l’application serveur REMOCRA (par défaut 8881) |
| REMOCRA_URL | L’adresse https permettant à accéder à l’interface REMOcRA sans “/” à la fin.  |
| CODE_SDIS | Code du SDIS, doit correspondre à une valeur de l’énumération présente dans le fichier : https://github.com/SDIS83-GSIC/REMOcRA-Application/blob/master/app/src/main/kotlin/remocra/data/enums/CodeSdis.kt[] |
| EPSG_NAME | Nom de la projection (par exemple _EPSG:2154_) |
| EPSG_PROJECTION | La projection |
| ENVIRONNEMENT a| Peut avoir les valeurs suivantes :

* DEVELOPPEMENT
* FORMATION
* RECETTE
* PREPRODUCTION
* PRODUCTION  |

.5+| *Informations de connexion à la base SIG du SDIS
(les valeurs sont optionnelles)*
| SIG_HOSTNAME | |
| SIG_SQL_DIALECT | |
| SIG_DBNAME | |
| SIG_USERNAME | |
| SIG_PASSWORD | |

.6+| *Keycloak*
| KEYCLOAK_ADMIN | Nom de l’utilisateur pour se connecter à Keycloak |
| KEYCLOAK_ADMIN_PASSWORD | Mot de passe de l’utilisateur pour se connecter à Keycloak |
| CLIENT_SECRET | |
| CLIENT_ID | est initialisé par défaut |
| REALM | Valeur pour le realm utilisé dans keycloak. Par défaut remocra |
| BASE_URI | L’adresse https permettant à accéder à l’interface keycloak |

.7+| *Apache Hop*
|APACHE_HOP_ENABLE | Activation d'Apache Hop dans l'application | `false`
| APACHE_HOP_URL | URL d'Apache Hop (facultatif si APACHE_HOP_ENABLE est à `false`) |
| APACHE_HOP_USERNAME | Login pour la connexion à Apache HOP (facultatif si APACHE_HOP_ENABLE est à `false`) |
| APACHE_HOP_PASSWORD | Mot de passe pour la connexion à Apache HOP (facultatif si APACHE_HOP_ENABLE est à `false`) |
|===


=== Création d’un utilisateur REMOcRA

Un utilisateur _remocra_ est nécessaire. Voici les commandes à exécuter :
[source,console]
----
groupadd -g 2000 remocra
useradd -u 2000 -g remocra remocra
----

=== Création de dossiers

Créer les dossiers suivants et leur affecter tous deux les droits _remocra_ :

[source,console]
----
mkdir /var/log/remocra
mkdir /var/lib/remocra

chown -R remocra: /var/lib/remocra
chown -R remocra: /var/log/remocra
----

=== Démarrer les images

Lancer les commandes suivantes. Elles permettront de télécharger les images et de démarrer les différents conteneurs nécessaires au projet.

[source,console]
----
cd /opt/remocra/
docker compose up -d

# Passage des patchs de base de données
docker compose run --rm remocra migrate-db

----

=== Création et configuration du realm remocra

Pour finir la configuration du serveur, exécutez la commande suivante :
[source,console]
----
docker compose run --rm -e KEYCLOAK_URL=http://localhost:8080 keycloak keycloak-config-cli
----


=== Première connexion à l’application

Pour pouvoir se connecter à l’application REMOcRA, il faut dans un premier temps créer un utilisateur administrateur. Voici les étapes à suivre :

* se connecter à Keycloak et sélectionner le realm remocra

image:realm_remocra.png[Schéma de principe des briques logicielles]

* cliquer sur “User”

image:users.png[Liste des utilisateurs]

* en ajouter un nouveau

image:add_user.png[Ajouter un utilisateur]

* remplir le formulaire avec le nom, l’email et  identifiant :

image:add_user_form.png[Formulaire d'ajout d'un utilisateur]

* se connecter à l'interface de l'application