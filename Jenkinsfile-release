library 'atolcd-jenkins'

// Cette version doit être synchronisée :
// - avec le gradle/wrapper/gradle-wrapper.properties
// - avec les autres Jenkinsfiles
// La version dans les Jenkinsfiles n'est validée que lorsque leurs jobs sont exécutés,
// il faut donc s'assurer que la version est synchro par relecture de code lors des reviews
// (tous les Jenkinsfiles devraient être modifiés en même temps que le gradle-wrapper.properties)
def gradleImageVersion = '8.14.4-jdk21'

pipeline {
  options {
    disableConcurrentBuilds()
    buildDiscarder(logRotator(numToKeepStr: '10'))
  }
  parameters {
    string(name: 'REMOCRA_VERSION', defaultValue: '', description: 'Tag à builder')
  }
  agent any
  stages {
    stage('Sanity check') {
      steps {
        gradleInsideDocker(imageVersion: gradleImageVersion) {
          sh 'gradle wrapper'
        }
        verifyUnmodified('gradle/wrapper/gradle-wrapper.properties')
      }
      post {
        unsuccessful {
          sh 'git restore -- gradlew* gradle/wrapper/'
        }
      }
    }
    stage('Build AsciiDoc documentation') {
        steps {
            insideDocker(imageName: 'docker-registry.priv.atolcd.com/asciidoctor') {
                sh '/entrypoint.sh pdf atolcd --destination-dir doc/build/ doc/*.adoc'
                sh '/entrypoint.sh html --destination-dir doc/build/ --attribute data-uri doc/*.adoc'
            }
            sh """
                for f in doc/*.adoc; do
                    mv "doc/build/\$(basename "\$f" .adoc).pdf" "doc/build/remocra--\$(basename "\$f" .adoc)-${REMOCRA_VERSION}.pdf"
                    mv "doc/build/\$(basename "\$f" .adoc).html" "doc/build/remocra--\$(basename "\$f" .adoc)-${REMOCRA_VERSION}.html"
                done
            """
            archiveArtifacts artifacts: 'doc/build/*'
        }
        post {
            cleanup {
                sh 'rm doc/build/*'
            }
        }
    }
    stage('Build Gradle') {
        steps {
          withSidecarContainers(
            pg: [ imageName: 'postgis/postgis', imageVersion: '16-3.4', args: '-e "POSTGRES_DB=remocra" -e "POSTGRES_USER=remocra" -e "POSTGRES_PASSWORD=remocra"' ]
          ) {
            gradleInsideDocker(imageVersion: gradleImageVersion) {
              sh '''
                gradle --stacktrace build
                gradle --stacktrace cyclonedxDirectBom
                gradle --stacktrace flywayMigrateData -Pdb.url=jdbc:postgresql://pg/remocra -Pdb.user=remocra -Pdb.password=remocra
                gradle --stacktrace pgTest -Premocra.database.dataSource.serverName=pg -Pdb.url=jdbc:postgresql://pg/remocra -Pdb.user=remocra -Pdb.password=remocra
                '''
            }
          }
        }
    }
    stage('Build frontend') {
      steps {
        nodejsInsideDocker() {
          dir(path: 'frontend/') {
            sh '''
                npm ci
                npm run lint
                npm run build
                npx @cyclonedx/cyclonedx-npm --omit dev --package-lock-only > npm-sbom.json
              '''
          }
        }
      }
      post {
        always {
          dir (path: 'frontend/') {
            sh '''
              rm -rf node_modules/
              '''
          }
        }
      }
    }
    stage('Build docker remocra') {
      steps {
        dockerBuildAndPublish(imageName: "client-docker-registry.atolcd.com/atolcd/remocra-v3:${REMOCRA_VERSION}",
          dockerfile: 'docker/Dockerfile', buildArgs: [ REMOCRA_VERSION: params.REMOCRA_VERSION ]) { imageId ->
               dockerSbom image: imageId, file: 'docker-sbom.json', exclude: '/opt/remocra/'
             }
        dockerBuildAndPublish imageName: "client-docker-registry.atolcd.com/atolcd/remocra-v3-keycloak:${REMOCRA_VERSION}",
            buildDir: 'keycloak'
        dockerBuildAndPublish imageName: "client-docker-registry.atolcd.com/atolcd/remocra-v3-geoserver:${REMOCRA_VERSION}",
            buildDir: 'geoserver', buildArgs: [ REMOCRA_VERSION: params.REMOCRA_VERSION ]
        dockerBuildAndPublish imageName: "client-docker-registry.atolcd.com/atolcd/remocra-v3-apache-hop:${REMOCRA_VERSION}",
            buildDir: 'apachehop'
      }
    }
    stage ('Publish SBOM') {
      steps {
          smartDependencyTrackPublisher name: 'remocra-v3',
            version: versionMajorMinor(params.REMOCRA_VERSION),
            bomFiles: ['docker-sbom.json', 'frontend/npm-sbom.json', 'app/build/reports/cyclonedx-direct/bom.json'],
            classifier: 'APPLICATION',
            hierarchical: true
        }
      }
  }
  post {
    always {
      sh '''
        git checkout -- .
        git clean -f -d -x -e .gradle-user-home/ -e .cache/npm/
        '''
    }
  }
}
