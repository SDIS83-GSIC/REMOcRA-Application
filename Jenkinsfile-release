library 'atolcd-jenkins'

// Cette version doit être synchronisée :
// - avec le gradle/wrapper/gradle-wrapper.properties
// - avec les autres Jenkinsfiles
// La version dans les Jenkinsfiles n'est validée que lorsque leurs jobs sont exécutés,
// il faut donc s'assurer que la version est synchro par relecture de code lors des reviews
// (tous les Jenkinsfiles devraient être modifiés en même temps que le gradle-wrapper.properties)
def gradleImageVersion = '8.12.0-jdk21'

pipeline {
  options {
    disableConcurrentBuilds()
    buildDiscarder(logRotator(numToKeepStr: '10'))
  }
  parameters {
    string(name: 'REMOCRA_VERSION', defaultValue: '', description: 'Tag à builder')
  }
  agent any
  stages {
    stage('Sanity check') {
      steps {
        gradleInsideDocker(imageVersion: gradleImageVersion) {
          sh 'gradle wrapper'
        }
        verifyUnmodified('gradle/wrapper/gradle-wrapper.properties')
      }
      post {
        unsuccessful {
          sh 'git restore -- gradlew* gradle/wrapper/'
        }
      }
    }
    stage('Build Gradle') {
        steps {
          withSidecarContainers(
            pg: [ imageName: 'postgis/postgis', imageVersion: '16-3.4', args: '-e "POSTGRES_DB=remocra" -e "POSTGRES_USER=remocra" -e "POSTGRES_PASSWORD=remocra"' ]
          ) {
            gradleInsideDocker(imageVersion: gradleImageVersion) {
              sh '''
                gradle --stacktrace build
                gradle --stacktrace cyclonedxBom
                gradle --stacktrace flywayMigrateData -Pdb.url=jdbc:postgresql://pg/remocra -Pdb.user=remocra -Pdb.password=remocra
                '''
            }
          }
        }
    }
    stage('Build frontend') {
      steps {
        nodejsInsideDocker() {
          dir(path: 'frontend/') {
            sh '''
                npm install
                npm run lint
                npm run build
              '''
          }
        }
      }
      post {
        always {
          dir (path: 'frontend/') {
            sh '''
              rm -rf node_modules/
              '''
          }
        }
      }
    }
    stage('Build docker remocra') {
      steps {
        dockerBuildAndPublish(imageName: "client-docker-registry.atolcd.com/atolcd/remocra-v3:${REMOCRA_VERSION}",
          dockerfile: 'docker/Dockerfile') { imageId ->
               dockerSbom image: imageId, file: 'docker-sbom.json', exclude: '/opt/remocra/'
             }
        dockerBuildAndPublish imageName: "client-docker-registry.atolcd.com/atolcd/remocra-v3-keycloak:${REMOCRA_VERSION}",
            buildDir: 'keycloak'
      }
    }
      stage ('Generate application SBOM') {
        steps {
          nodejsInsideDocker {
            sh 'cd frontend/ && npm sbom --sbom-format cyclonedx --omit dev --sbom-type application --package-lock-only true > npm-sbom.json'
          }
        }
      }
      stage ('Publish SBOM') {
        steps {
           smartDependencyTrackPublisher name: 'remocra-v3',
             version: params.REMOCRA_VERSION,
             bomFiles: ['docker-sbom.json', 'frontend/npm-sbom.json', 'app/build/reports/bom.json'],
             classifier: 'APPLICATION',
             hierarchical: true
         }
       }
    }
  post {
    always {
      sh '''
        git checkout -- .
        git clean -f -d -x -e .m2/ -e .cache/npm/
        '''
    }
  }
}
